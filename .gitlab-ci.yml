# GitLab CI/CD Pipeline Configuration (Alternative to GitHub Actions)
# Usage: When deploying to GitLab instead of GitHub
# File location: .gitlab-ci.yml (repository root)

variables:
  REGISTRY: registry.gitlab.com
  IMAGE_NAME: ${REGISTRY}/privatetrade/backtesting-simulator
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""

stages:
  - build
  - test
  - quality
  - docker
  - deploy-staging
  - deploy-production
  - monitor

# ============================================
# STAGE 1: Build
# ============================================
build:
  stage: build
  image: node:18-alpine
  cache:
    paths:
      - node_modules/
  script:
    - npm ci
    - npm run build
    - npm run lint
  artifacts:
    paths:
      - dist/
      - backend/
      - frontend/
    expire_in: 1 hour
  only:
    - main
    - develop
    - /^v\d+\.\d+\.\d+$/
  tags:
    - docker

# ============================================
# STAGE 2: Unit Tests
# ============================================
unit-test:
  stage: test
  image: node:18-alpine
  cache:
    paths:
      - node_modules/
  services:
    - sqlite:latest
  script:
    - npm ci
    - npm run test:unit -- --coverage --reporters=default --reporters=jest-junit
  artifacts:
    reports:
      junit: test-results/junit.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
      - test-results/
    expire_in: 30 days
  coverage: '/Lines\s*:\s*(\d+\.\d+)%/'
  only:
    - main
    - develop
    - merge_requests
  tags:
    - docker

# ============================================
# STAGE 2: Integration Tests
# ============================================
integration-test:
  stage: test
  image: node:18-alpine
  cache:
    paths:
      - node_modules/
  services:
    - sqlite:latest
  script:
    - npm ci
    - npm run test:integration
  artifacts:
    paths:
      - test-results/
    expire_in: 30 days
  only:
    - main
    - develop
  tags:
    - docker

# ============================================
# STAGE 3: Code Quality (SonarQube)
# ============================================
sonarqube-check:
  stage: quality
  image: sonarsource/sonar-scanner-cli:latest
  script:
    - sonar-scanner
      -Dsonar.projectKey=privatetrade
      -Dsonar.sources=src/
      -Dsonar.host.url=${SONAR_HOST_URL}
      -Dsonar.login=${SONAR_TOKEN}
  only:
    - main
    - develop
    - merge_requests
  tags:
    - docker
  allow_failure: true

# ============================================
# STAGE 3: Security Scan (SAST)
# ============================================
dependency-check:
  stage: quality
  image: node:18-alpine
  script:
    - npm ci
    - npm audit --audit-level=moderate || true
  only:
    - main
    - develop
    - merge_requests
  tags:
    - docker

# ============================================
# STAGE 4: Build Docker Image
# ============================================
docker-build:
  stage: docker
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build
      --tag ${IMAGE_NAME}:${CI_COMMIT_SHA:0:8}
      --tag ${IMAGE_NAME}:${CI_COMMIT_REF_SLUG}
      --tag ${IMAGE_NAME}:latest
      .
    - docker push ${IMAGE_NAME}:${CI_COMMIT_SHA:0:8}
    - docker push ${IMAGE_NAME}:${CI_COMMIT_REF_SLUG}
  only:
    - main
    - develop
    - /^v\d+\.\d+\.\d+$/
  tags:
    - docker

# ============================================
# STAGE 5: Deploy to Staging
# ============================================
deploy-staging:
  stage: deploy-staging
  image: alpine:latest
  environment:
    name: staging
    url: http://staging.privatetrade.local:3000
  before_script:
    - apk add --no-cache curl
  script:
    - echo "Deploying to staging..."
    - echo "Image: ${IMAGE_NAME}:${CI_COMMIT_REF_SLUG}"
    # 실제 배포 스크립트 (docker-compose 또는 kubectl)
    - "curl -X POST http://deploy-webhook.internal/deploy -d @- <<EOF
      {
        \"environment\": \"staging\",
        \"image\": \"${IMAGE_NAME}:${CI_COMMIT_REF_SLUG}\",
        \"version\": \"${CI_COMMIT_SHA:0:8}\"
      }
      EOF"
  after_script:
    - |
      # Smoke test
      for i in {1..30}; do
        if curl -f http://staging.privatetrade.local:8000/api/health; then
          echo "✅ Staging deployment successful"
          exit 0
        fi
        sleep 2
      done
      echo "❌ Staging health check failed"
      exit 1
  only:
    - develop
  tags:
    - docker

# ============================================
# STAGE 6: Deploy to Production
# ============================================
deploy-production:
  stage: deploy-production
  image: alpine:latest
  environment:
    name: production
    url: http://privatetrade.local:3000
  before_script:
    - apk add --no-cache curl
  script:
    - VERSION=$(echo ${CI_COMMIT_TAG} | sed 's/v//')
    - echo "Deploying v${VERSION} to production..."
    - echo "Image: ${IMAGE_NAME}:${CI_COMMIT_TAG}"
    # Blue-Green deployment
    - |
      curl -X POST http://deploy-webhook.internal/deploy-blue-green \
        -H 'Content-Type: application/json' \
        -d "{
          \"version\": \"${CI_COMMIT_TAG}\",
          \"image\": \"${IMAGE_NAME}:${CI_COMMIT_TAG}\",
          \"strategy\": \"blue-green\",
          \"rollback_timeout_minutes\": 1440
        }"
  after_script:
    - |
      # Production health check
      for i in {1..60}; do
        if curl -f http://privatetrade.local:8000/api/health; then
          echo "✅ Production deployment successful"
          exit 0
        fi
        sleep 5
      done
      echo "❌ Production health check failed - triggering rollback"
      curl -X POST http://deploy-webhook.internal/rollback
      exit 1
  only:
    - /^v\d+\.\d+\.\d+$/
  when: manual
  tags:
    - docker

# ============================================
# STAGE 7: Monitoring & Alerts
# ============================================
production-monitoring:
  stage: monitor
  image: curlimages/curl:latest
  script:
    - echo "Monitoring production for 24 hours..."
    - |
      for i in {1..1440}; do
        RESPONSE=$(curl -s -w "%{http_code}" -o /tmp/response.json http://privatetrade.local:8000/api/health)
        if [ "$RESPONSE" != "200" ]; then
          echo "⚠️ Health check failed (attempt $i): HTTP $RESPONSE"
        fi
        sleep 60
      done
  only:
    - /^v\d+\.\d+\.\d+$/
  when: manual
  tags:
    - docker

# ============================================
# Schedule Jobs
# ============================================
# Weekly backup
backup-database:
  stage: monitor
  script:
    - echo "Creating database backup..."
    - "sqlite3 /prod/backtest.db '.backup /backups/backtest-$(date +%Y%m%d).db'"
  only:
    - schedules
  tags:
    - docker
