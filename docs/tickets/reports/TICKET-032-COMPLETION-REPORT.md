# TICKET-032 완료 보고서
## 백테스팅 엔진 최대 수량 구매 버그 수정

**작성일**: 2026-02-08  
**상태**: ✅ 완료

---

## 1. 버그 설명

### 문제점
초기 자본금 1,000만원으로 10,000원 주가의 주식을 구매할 때:
- **예상**: 최대 1,000주 구매 (10,000,000 ÷ 10,000 = 1,000주)
- **실제**: 1주만 구매됨

### 근본 원인
[py_backtest/backtest_engine.py](py_backtest/backtest_engine.py)의 `run_backtest()` 메서드 106번 줄에서:
```python
self.buy(date, close_price, quantity=strategy.get('quantity', 1))
```
고정된 수량(1주 또는 strategy에서 정의된 수량)만 사용하고 있었습니다.

---

## 2. 수정 사항

### 변경된 코드
[py_backtest/backtest_engine.py](py_backtest/backtest_engine.py) - `run_backtest()` 메서드 (104~120줄)

**수정 전**:
```python
if idx in buy_signals:
    self.buy(date, close_price, quantity=strategy.get('quantity', 1))
    trades_executed += 1
elif idx in sell_signals:
    self.sell(date, close_price)
    trades_executed += 1
```

**수정 후**:
```python
if idx in buy_signals:
    # 현재 잔고로 구매할 수 있는 최대 수량 계산
    max_quantity = int(self.current_cash / close_price)
    if max_quantity > 0:
        self.buy(date, close_price, quantity=max_quantity)
        trades_executed += 1
    else:
        logger.warning(f"Insufficient cash to buy at {date}: available {self.current_cash}, price {close_price}")
elif idx in sell_signals:
    self.sell(date, close_price)
    trades_executed += 1
```

### 주요 개선사항
1. **동적 수량 계산**: `max_quantity = int(self.current_cash / close_price)`
   - 현재 잔고(self.current_cash)와 주가(close_price)로 구매 가능한 최대 주식 수를 자동 계산
   
2. **현금 검증**: `if max_quantity > 0`
   - 구매 가능한 수량이 0보다 큰 경우만 거래 실행
   
3. **로깅 강화**: 현금 부족 상황에 대한 경고 메시지 추가

---

## 3. 테스트 결과

### 3.1 TICKET-032 핵심 테스트 결과 ✅

**테스트 케이스**: 초기자본 1,000만원, 주가 10,000원 고정
```
테스트 데이터:
  - 기간: 2024-01-01 ~ 2024-04-09 (100일)
  - 주가: ₩10,000 (고정)
  - 초기 자본금: ₩10,000,000
  - 예상 최대 구매량: 1,000주

백테스팅 결과:
  - 총 거래 횟수: 2 (매수 1, 매도 1)
  - 수익: ₩0
  - 수익률: 0.00%
  - 최종 자산: ₩10,000,000
```

**첫 번째 매수 결과**:
```
  - 날짜: 2024-01-01 00:00:00
  - 가격: ₩10,000
  - 수량: 1,000주          ✓ PASS (예상값: 1,000주)
  - 비용: ₩10,000,000       ✓ PASS
  - 남은 현금: ₩0           ✓ PASS
```

### 3.2 호환성 테스트 결과 ✅

| 케이스 | 초기자본 | 주가 | 예상 수량 | 실제 수량 | 결과 |
|--------|--------|------|---------|---------|------|
| 1 | 10,000,000 | 10,000 | 1,000주 | 1,000주 | ✓ PASS |
| 2 | 10,000,000 | 5,000 | 2,000주 | 2,000주 | ✓ PASS |
| 3 | 10,000,000 | 50,000 | 200주 | 200주 | ✓ PASS |
| 4 | 10,000,000 | 100,000 | 100주 | 100주 | ✓ PASS |
| 5 | 5,000,000 | 10,000 | 500주 | 500주 | ✓ PASS |

모든 호환성 테스트 통과 ✅

### 3.3 기존 테스트 호환성 검증 ✅

**test_backtest_fix.py (TICKET-021) 실행 결과**:
```
테스트 데이터:
  - 기간: 2024-01-01 ~ 2024-04-09 (100일)
  - 초기 자본금: ₩1,000,000
  - 주가 변동: ₩101 → ₩117.50

백테스팅 결과:
  - 총 거래 수: 1 (매도)
  - 총 수익: ₩163,350
  - 수익률: 16.34%
  - 승률: 100.00%
  - 종료 자산: ₩1,163,350

검증 항목:
  ✓ 거래 생성됨
  ✓ 매수 거래 1건 이상
  ✓ 매도 거래 1건 이상
  ✓ 수익 계산됨
  ✓ 수익률 계산됨
```

기존 테스트와 완벽한 호환성 유지 ✅

---

## 4. 기술 분석

### 4.1 계산 로직 검증

**적용된 수식**:
$$\text{max_quantity} = \left\lfloor \frac{\text{현재 잔고}}{\text{주가}} \right\rfloor$$

**예시 계산**:
- 초기 자본금: ₩10,000,000
- 주가: ₩10,000
- 최대 수량: $\lfloor 10,000,000 \div 10,000 \rfloor = 1,000주$

### 4.2 안정성 개선

1. **0보다 큰 수량 검증**: 거래 실행 전 수량 확인으로 음수 거래 방지
2. **현금 부족 처리**: 구매 불가능 상황에 대한 로깅으로 디버깅 용이
3. **정수 변환**: `int()`를 사용하여 일관된 주식 단위 처리

---

## 5. 영향 분석

### 5.1 영향받는 기능
- ✅ 백테스팅 엔진의 매수 로직
- ✅ 성과 지표 계산
- ✅ 포지션 관리

### 5.2 하위 호환성
- ✅ 기존 API 변경 없음 (strategy 파라미터 구조 유지)
- ✅ 기존 테스트 사례 모두 통과
- ✅ Log 형식 일관성 유지

---

## 6. 완료 체크리스트

| 항목 | 상태 | 비고 |
|------|------|------|
| 코드 수정 완료 | ✅ | py_backtest/backtest_engine.py 수정 |
| 핵심 기능 테스트 | ✅ | 1,000만원 × 10,000원 = 1,000주 |
| 호환성 테스트 | ✅ | 5가지 케이스 모두 통과 |
| 기존 테스트 호환성 | ✅ | test_backtest_fix.py 통과 |
| 로깅 메시지 추가 | ✅ | 현금 부족 상황 로그 추가 |
| 문서화 | ✅ | 코드 주석 및 본 보고서 |
| test_ticket_032.py 생성 | ✅ | 새 테스트 파일 추가 |

---

## 7. 배포 및 운영

### 7.1 영향도 평가
- **범위**: mediummedium - 백테스팅 엔진의 핵심 로직 변경
- **조치**: 모든 테스트 케이스 통과 확인

### 7.2 모니터링 포인트
- 백테스팅 실행 후 매수 거래 수량 검증
- 다양한 자본금과 주가 조합에서의 동작 확인
- 로그에서 "Insufficient cash" 경고의 빈도 추적

---

## 8. 결론

✅ **TICKET-032 완료**

초기 자본금 1,000만원으로 10,000원 주가의 주식을 구매할 때:
- **수정 전**: 1주만 구매됨 (버그)
- **수정 후**: 1,000주 구매됨 (정상 작동) ✓

모든 테스트 통과 및 기존 호환성 유지 확인됨.

---

## 첨부: 테스트 파일

### test_ticket_032.py
신규 생성된 테스트 파일로, 다음을 검증합니다:
1. 최대 수량 매수 (1,000만원 × 10,000원 = 1,000주)
2. 거래 비용 계산 정확도
3. 남은 현금 계산
4. 다양한 주가에서의 호환성 (5가지 케이스)

### 실행 명령어
```bash
python test_ticket_032.py
```

**예상 결과**: 모든 검증 통과 ✓

---

**최종 승인**: 2026-02-08
