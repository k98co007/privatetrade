# High Level Design (HLD) - v1.1 DELTA
**버전**: 1.1 (Patch - 기본 아키텍처 유지, API/컴포넌트 확장)  
**기반**: TICKET-008 (SRS 2.0 재검토)  
**작성일**: 2026년 2월 8일  
**변경 사항**: 특정 종목 선택 기능 추가 (US-007, FR-106~109)  

---

## 1. 아키텍처 영향도 분석

### 1.1 기본 아키텍처 유지
- **선택안**: 기존 **모노리틱 아키텍처** 유지
- **근거**:
  - 특정 종목 선택은 데이터 필터링 로직 추가일 뿐, 아키텍처 변경 아님
  - 기존 3계층 구조(API → 비즈니스 로직 → 데이터) 활용 가능
  - 새 API 엔드포인트 추가: `/api/stocks/*` (기존 `/api/*` 위에 확장)

### 1.2 기술 스택 변경사항
| 계층 | 기술 | 변경사항 |
|------|------|---------|
| **API 라우터** | Express.js | **/api/stocks/* 엔드포인트 추가** (기존 라우터 확장) |
| **비즈니스 로직** | Node.js | **StockFilter 모듈 추가** (특정 종목 필터링) |
| **데이터 저장** | SQLite | **config 테이블에 stock_mode, selected_stocks 필드 추가** |
| 기타 | (변경 없음) | 프론트엔드, WebSocket, Python 스크립트 유지 |

---

## 2. API 엔드포인트 추가 (4개)

### 2.1 기존 API (유지)
- `POST /api/blacklist/add` (블랙리스트 추가)
- `DELETE /api/blacklist/{code}` (블랙리스트 제거)
- `POST /api/whitelist/add` (화이트리스트 추가)
- `DELETE /api/whitelist/{code}` (화이트리스트 제거)
- `POST /api/strategy/config` (전략 설정)
- `POST /api/backtest/start` (백테스팅 시작) - **수정: stock_mode 파라미터 추가**
- `GET /api/backtest/progress` (진행상황)
- `GET /api/backtest/result/{id}` (결과 조회)

### 2.2 신규 API (4개)
```
POST /api/stocks/mode
  - 요청: { "mode": "specific" | "filtered" | "all" }
  - 응답: { "success": true, "current_mode": "specific" }

POST /api/stocks/specific/add
  - 요청: { "codes": ["005930", "000660"] }
  - 응답: { "success": true, "selected_count": 2, "selected_stocks": [...] }

GET /api/stocks/specific
  - 응답: { "selected_count": 2, "selected_stocks": [...] }

DELETE /api/stocks/specific/{code}
  - 응답: { "success": true, "selected_count": 1 }
```

---

## 3. 컴포넌트 변경사항

### 3.1 기존 9개 컴포넌트 중 3개 수정

```
┌─────────────────────────────────────────────────────────────┐
│              백엔드 서버 (Node.js + Express)                 │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              API 라우터 계층 [수정]                    │   │
│  │  - /api/stocks/mode [신규]                           │   │
│  │  - /api/stocks/specific/* [신규 3개]                │   │
│  │  - 기존 엔드포인트들...                                │   │
│  └──────────────────────────────────────────────────────┘   │
│                          ↓                                   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │          비즈니스 로직 계층 [수정]                     │   │
│  │  - BacktestEngine [수정: stock_mode 파라미터 처리]   │   │
│  │  - DataManager [수정: 특정 종목 필터링 로직]         │   │
│  │  - **StockFilter [신규: 특정 종목 필터링 모듈]**   │   │
│  │  - StrategyExecutor (유지)                           │   │
│  │  - ResultProcessor (유지)                            │   │
│  │  - WebSocketManager (유지)                           │   │
│  │  - ConfigRepository [수정: stock_mode 필드]         │   │
│  └──────────────────────────────────────────────────────┘   │
│                          ↓                                   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │            데이터 저장소 [수정]                        │   │
│  │  - SQLite DB (backtest.db)                           │   │
│  │    ├─ config 테이블 [수정: stock_mode, ...필드]     │   │
│  │    ├─ backtest_session 테이블                        │   │
│  │    ├─ backtest_result 테이블                         │   │
│  │    └─ trade_detail 테이블                            │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 컴포넌트별 변경 내역

| 컴포넌트 | 변경 사항 | 영향도 | 비고 |
|---------|---------|--------|------|
| APIRouter | POST /api/stocks/mode, /add, /GET, DELETE 추가 | Low | 라우팅만 추가 |
| BacktestEngine | stock_mode 파라미터 처리 추가 | Low | 기존 로직 유지, 필터링 데이터만 변경 |
| DataManager | 특정 종목 필터링 로직 추가 (StockFilter 호출) | Low | 기존 자료구조 유지 |
| **StockFilter** | **신규 모듈 (특정 종목 필터링)** | N/A | - |
| ConfigRepository | stock_mode, selected_specific_stocks 필드 추가 | Low | DB 스키마 마이그레이션 필요 |
| StrategyExecutor | 변경 없음 | None | - |
| ResultProcessor | stock_mode 정보 저장 | Low | 메타데이터 추가 |
| WebSocketManager | 변경 없음 | None | - |
| 프론트엔드 | 특정 종목 선택 UI 추가 | Low | 기존 UI 모드 추가 |

---

## 4. 데이터 흐름 (특정 종목 모드)

```
[프론트엔드]
사용자가 "특정 종목만" 라디오 선택
  ↓
POST /api/stocks/mode { mode: "specific" }
  ↓
[APIRouter] → stocks/mode 라우트 처리
  ↓
[ConfigRepository] stock_mode = "specific" 저장
  ↓ (응답)
200 OK { "current_mode": "specific" }
  ↓
[프론트엔드] 특정 종목 추가 UI 표시

---

사용자가 서로 다른 종목 선택 & 추가
  ↓
POST /api/stocks/specific/add { codes: ["005930", "000660"] }
  ↓
[APIRouter] → stocks/specific/add 라우트
  ↓
[ConfigRepository.updateSpecificStocks(codes)]
  ↓ (저장)
db.config.selected_specific_stocks = ["005930", "000660"]
  ↓ (응답)
200 OK { "selected_count": 2, "selected_stocks": [...] }

---

사용자가 "백테스팅 시작" 클릭
  ↓
POST /api/backtest/start 
{ 
  config_id: "cfg_001",
  stock_mode: "specific",
  selected_stocks: ["005930", "000660"]
}
  ↓
[APIRouter] → backtest/start 라우트
  ↓
[BacktestEngine.start(config, stock_mode, selected_stocks)]
  ↓
[DataManager.filterStocks(stock_mode, selected_stocks)]
  ↓
[StockFilter.applySpecificFilter(selected_stocks)] ← 신규
  - KOSPI 200 전체 리스트 로드
  - selected_stocks와 교차 필터링
  - ["005930", "000660"] 만 반환
  ↓
[BacktestEngine.executeBacktest(filtered_stocks, strategy)]
  → 삼성전자, SK하이닉스에 대해서만 시뮬레이션 실행
  ↓
[ResultProcessor] 결과 저장 (stock_mode, selected_stocks 메타 저장)
  ↓
WebSocket 진행상황 푸시 (2/2 종목 완료 등)
```

---

## 5. 데이터베이스 스키마 변경 (마이그레이션)

### 5.1 config 테이블 (추가 필드)
```sql
-- 신규 필드
ALTER TABLE config ADD COLUMN stock_mode TEXT DEFAULT 'all';
                        -- 값: 'all', 'filtered', 'specific'

ALTER TABLE config ADD COLUMN selected_specific_stocks TEXT;
                        -- JSON array: '["005930", "000660"]'

-- 예시 행
INSERT INTO config (id, stock_mode, selected_specific_stocks, strategy, created_at)
VALUES (2, 'specific', '["005930", "000660"]', 'daily_trading', NOW());
```

---

## 6. 배포 영향도

| 항목 | 영향 | 범위 |
|------|------|------|
| **빌드** | npm install (새 라이브러리 불필요) | 낮음 |
| **데이터베이스** | 마이그레이션 스크립트 실행 (schema 변경) | 중간 |
| **배포** | 기존 docker-compose.yml 유지 | 낮음 |
| **회귀 테스트** | 기존 3가지 모드 모두 테스트 필요 | 중간 |

---

## 7. 결론

- **HLD 버전**: 1.0 → **1.1** (Patch 증가)
  - 기본 아키텍처 변경 없음 (모노리틱 유지)
  - API 4개 추가, 컴포넌트 3개 수정, 신규 StockFilter 모듈
  - 데이터베이스 스키마 확장
- **영향도**: **낮음** (기존 구조 활용, 신규 기능 추가 형태)
- **위험도**: **낮음** (기존 코드 수정 최소화, 신규 모듈 독립적)

---

## 변경 이력

| 버전 | 작성자 | 작성일 | 변경 사항 |
|------|--------|--------|---------|
| 1.0 | HLD_담당자 | 2026-02-08 | 기본 설계: 모노리틱 아키텍처, 3계층, 9개 컴포넌트 |
| 1.1 | HLD_담당자 | 2026-02-08 | **특정 종목 선택 기능**: API 4개, StockFilter, DB 필드 추가 |

---

## 다음 단계
- LLD 담당자: HLD 1.1 기반 설계 (TICKET-009)
  - StockFilter 클래스/함수 설계
  - ConfigRepository 확장
  - DataManager 수정
