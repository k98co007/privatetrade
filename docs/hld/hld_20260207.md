# High Level Design (HLD)
**버전**: 1.0  
**기반**: TICKET-003 (SRS)  
**작성일**: 2026년 2월 8일  

---

## 1. 시스템 개요 및 아키텍처 선택

### 1.1 아키텍처 패턴
- **선택안**: **모노리틱 아키텍처** (Monolithic)
- **근거**: 
  - 초기 MVP 수준의 단순 시스템
  - 배포 및 운영 복잡도 최소화
  - 로컬 배포로 마이크로서비스 오버헤드 불필요
  - 향후 기능 확장 시 모듈화 로직이 있어 쉬운 분산 전환 가능

### 1.2 기술 스택 선택

| 계층 | 기술 | 버전 | 사유 |
|------|------|------|------|
| **프론트엔드** | HTML5 + Bootstrap | 5.x | 반응형 UI, 빠른 개발 |
| **프론트엔드 JS** | Vanilla JS / Vue.js | 3.x | 경량, 높은 성능 |
| **차트** | TradingView Lightweight | - | 금융 차트 전문 |
| **백엔드** | Node.js + Express | 18.x | JavaScript 풀스택 |
| **데이터 저장** | SQLite (또는 JSON 파일) | 3.x | 경량, 설정 최소 |
| **실시간 통신** | WebSocket (ws 라이브러리) | - | 진행상황 실시간 송수신 |
| **외부 API** | Yahoo Finance Python | - | 시가 데이터 수집 |

### 1.3 배포 환경
- **서버**: 로컬 개발 PC (localhost)
- **포트**: 프론트엔드 3000, 백엔드 8000
- **OS 지원**: Windows, macOS, Linux
- **Docker**: 선택 사항 (간단한 docker-compose.yml 제공)

---

## 2. 시스템 아키텍처 다이어그램

```
┌─────────────────────────────────────────────────────────────┐
│                    웹브라우저 (localhost:3000)               │
│  ┌──────────────────────────────────────────────────────┐   │
│  │           프론트엔드 (HTML/CSS/JavaScript)           │   │
│  │  - 종목 관리 UI (블랙/화이트 리스트)                 │   │
│  │  - 전략 설정 UI                                       │   │
│  │  - 백테스팅 실행 & 모니터링 UI                      │   │
│  │  - 결과 조회 및 차트 시각화 UI                       │   │
│  └──────────────────────────────────────────────────────┘   │
│                          ↓ (REST API + WebSocket)           │
│                 localhost:8000                               │
└─────────────────────────────────────────────────────────────┘
         ↓ HTTP/WebSocket ↓
┌─────────────────────────────────────────────────────────────┐
│              백엔드 서버 (Node.js + Express)                 │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              API 라우터 계층                          │   │
│  │  - /api/blacklist/* (블랙리스트 관리)               │   │
│  │  - /api/whitelist/* (화이트리스트 관리)             │   │
│  │  - /api/strategy/* (전략 설정)                       │   │
│  │  - /api/backtest/* (백테스팅 실행/모니터링)        │   │
│  │  - /api/result/* (결과 조회)                         │   │
│  └──────────────────────────────────────────────────────┘   │
│                          ↓                                   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │          비즈니스 로직 계층                           │   │
│  │  - BacktestEngine (시뮬레이션 엔진)                 │   │
│  │  - StrategyExecutor (전략 실행)                      │   │
│  │  - DataManager (데이터 수집 및 캐싱)                │   │
│  │  - ResultProcessor (결과 처리 및 저장)              │   │
│  │  - WebSocketManager (실시간 통신)                    │   │
│  └──────────────────────────────────────────────────────┘   │
│                          ↓                                   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │            데이터 접근 계층                           │   │
│  │  - ConfigRepository (설정 저장소)                    │   │
│  │  - ResultRepository (결과 저장소)                    │   │
│  │  - CacheRepository (데이터 캐시)                     │   │
│  └──────────────────────────────────────────────────────┘   │
│                          ↓                                   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │         데이터 저장소                                 │   │
│  │  - SQLite DB (backtest.db)                           │   │
│  │    ├─ config 테이블                                  │   │
│  │    ├─ backtest_session 테이블                        │   │
│  │    ├─ backtest_result 테이블                         │   │
│  │    └─ trade_detail 테이블                            │   │
│  │  - JSON 파일 (data/config/*.json)                    │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
         ↓ Python Script 호출 (별도 프로세스) ↓
┌─────────────────────────────────────────────────────────────┐
│           외부 데이터 소스 & 시뮬레이션 엔진                  │
│  - Yahoo Finance API (주식 데이터 수집)                     │
│  - Python Backtesting Engine (별도 프로세스)               │
│    └─ 종목별 시뮬레이션 실행, 거래내역 계산                 │
│    └─ 결과를 JSON으로 백엔드에 반환                        │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. 주요 컴포넌트 설명

### 3.1 프론트엔드 컴포넌트

#### FC-001: UI 컨트롤러
- **역할**: HTML 페이지 관리, 사용자 입력 수신
- **파일**: `public/index.html`, `public/css/`, `public/js/`
- **인터페이스**:
  - 입력: 사용자 클릭, 입력값
  - 출력: 백엔드 API 호출, UI 업데이트

#### FC-002: API 클라이언트
- **역할**: 백엔드 REST API 호출 및 응답 처리
- **파일**: `public/js/api-client.js`
- **메서드**:
  - `getBlacklist()`: GET /api/blacklist
  - `addBlacklist(code)`: POST /api/blacklist/add
  - `startBacktest(config)`: POST /api/backtest/start
  - `getResults(sessionId)`: GET /api/result/{sessionId}

#### FC-003: WebSocket 클라이언트
- **역할**: 실시간 진행상황 수신
- **파일**: `public/js/websocket-client.js`
- **이벤트**:
  - `onProgress`: `{ total_symbols, completed_symbols, current_symbol, eta_sec }`
  - `onCompleted`: `{ total_profit, profit_rate_pct }`

#### FC-004: 차트 렌더러
- **역할**: 2분 봉 차트 및 결과 차트 렌더링
- **파일**: `public/js/chart-renderer.js`
- **라이브러리**: TradingView Lightweight Charts
- **기능**:
  - 캔들 차트 그리기
  - 매수/매도 마커 표시
  - 확대/축소

### 3.2 백엔드 컴포넌트

#### BC-001: API 라우터
- **역할**: HTTP 요청 라우팅, 요청/응답 검증
- **파일**: `backend/routes/`
  - `blacklist.js` (블랙리스트 CRUD)
  - `whitelist.js` (화이트리스트 CRUD)
  - `strategy.js` (전략 설정)
  - `backtest.js` (백테스팅 관련)
  - `result.js` (결과 조회)
- **인터페이스**: RESTful HTTP (GET, POST, DELETE)

#### BC-002: BacktestEngine
- **역할**: 백테스팅 시뮬레이션 실행 및 조율
- **파일**: `backend/services/BacktestEngine.js`
- **메서드**:
  - `start(sessionId, config, symbols)`: 백테스팅 시작
  - `cancel(sessionId)`: 백테스팅 중단
  - `reportProgress(completed, total)`: 진행상황 보고
- **로직**:
  1. 선택된 종목 목록 생성 (블랙/화이트 리스트 적용)
  2. Python 백테스팅 엔진 프로세스 호출 (각 종목별)
  3. WebSocket으로 진행상황 실시간 전송
  4. 완료되면 결과 DB에 저장

#### BC-003: StrategyExecutor
- **역할**: 투자 전략별 매수/매도 로직 실행
- **파일**: `backend/services/StrategyExecutor.js`
- **전략**:
  - `strategy1_dailyTrading`: 고정시간 매수/매도
  - `strategy2_trailingStop`: Trailing Stop 전략
- **입력**: 2분 봉 데이터, 전략 파라미터
- **출력**: 거래 내역 리스트 (매수가, 매도가, 시간 등)

#### BC-004: DataManager
- **역할**: 외부 데이터 수집, 캐싱, 관리
- **파일**: `backend/services/DataManager.js`
- **메서드**:
  - `fetchStockData(code, startDate, period)`: Yahoo Finance에서 2분 봉 데이터 수집
  - `getCachedData(code)`: 캐시에서 데이터 조회
  - `getSymbolList()`: 코스피 200 종목 목록 조회
- **캐시 전략**: 메모리 캐시 (또는 Redis, 초기는 메모리)

#### BC-005: ResultProcessor
- **역할**: 거래 결과 계산, 비용 적용, 결과 저장
- **파일**: `backend/services/ResultProcessor.js`
- **기능**:
  - 거래별 수익/손해 계산
  - 비용 적용 (세금 0.2%, 수수료 0.011%)
  - 씨드머니 손해액 계산
  - 결과 요약 (총 수익, 수익률 등)
  - DB 저장

#### BC-006: WebSocketManager
- **역할**: 클라이언트 WebSocket 연결 관리, 메시지 브로드캐스트
- **파일**: `backend/services/WebSocketManager.js`
- **메서드**:
  - `broadcast(event, data)`: 모든 연결된 클라이언트에 메시지 전송
  - `sendProgress(sessionId, progress)`: 특정 세션의 진행상황 전송

### 3.3 데이터 저장 컴포넌트

#### BC-007: ConfigRepository
- **역할**: 블랙리스트, 화이트리스트, 전략 설정 저장소
- **저장소**: SQLite 또는 JSON 파일
- **테이블/파일**:
  - `config` 테이블 (전략 설정)
  - `data/blacklist.json` (블랙리스트)
  - `data/whitelist.json` (화이트리스트)

#### BC-008: ResultRepository
- **역할**: 백테스팅 결과 저장소
- **저장소**: SQLite
- **테이블**:
  - `backtest_session`: 세션 메타데이터
  - `backtest_result`: 종목별 결과 요약
  - `trade_detail`: 거래 상세 내역

#### BC-009: CacheRepository
- **역할**: 주식 데이터 캐시
- **데이터**: 2분 봉 OHLCV 데이터
- **캐시 정책**: 일일 1회 수집 (TTL 24시간) — 당일 이미 수집한 종목은 캐시 재사용
- **캐시 저장소**: 메모리 캐시 + 디스크 캐시(SQLite 또는 JSON 파일) 병행 (서버 재시작 시에도 당일 데이터 유지)
- **캐시 갱신 조건**: `lastUpdated`가 당일(00:00 이후)이면 캐시 사용, 아니면 Yahoo Finance 재수집

---

## 4. 인터페이스 정의

### 4.1 REST API 명세

#### 블랙리스트 API

```
GET /api/blacklist
응답: { "blacklist": [{ "code": "005930", "name": "삼성전자" }, ...] }

POST /api/blacklist/add
요청: { "code": "005930" }
응답: { "success": true, "blacklist_count": 15 }

DELETE /api/blacklist/{code}
응답: { "success": true, "blacklist_count": 14 }
```

#### 화이트리스트 API

```
GET /api/whitelist
응답: { "whitelist": [{ "code": "066570", "name": "삼성전자우" }, ...] }

POST /api/whitelist/add
요청: { "code": "066570" }
응답: { "success": true, "whitelist_count": 5 }

DELETE /api/whitelist/{code}
응답: { "success": true, "whitelist_count": 4 }
```

#### 전략 API

```
POST /api/strategy/config
요청: {
  "strategy": "daily_trading",
  "buy_time": "10:00",
  "sell_time": "15:00"
}
응답: { "success": true, "config_id": "cfg_001" }
```

#### 백테스팅 API

```
POST /api/backtest/start
요청: {
  "config_id": "cfg_001",
  "blacklist": ["005930"],
  "whitelist": ["066570"]
}
응답: { "success": true, "session_id": "sess_abc123" }

GET /api/backtest/progress/{session_id}
응답: { "status": "running", "completed": 75, "total": 200 }

POST /api/backtest/cancel/{session_id}
응답: { "success": true }
```

#### 결과 API

```
GET /api/result/{session_id}/summary
응답: {
  "total_profit": 450000,
  "profit_rate": 4.5,
  "trade_count": 150,
  "win_count": 100,
  "loss_count": 50
}

GET /api/result/{session_id}/symbols
응답: {
  "results": [
    { "code": "005930", "trade_count": 10, "profit": 45000 },
    ...
  ]
}

GET /api/result/{session_id}/trades/{symbol_code}
응답: {
  "trades": [
    {
      "trade_id": 1,
      "buy_time": "2026-02-01 10:00",
      "buy_price": 70000,
      "sell_time": "2026-02-01 15:00",
      "sell_price": 71000,
      "profit": 1000
    },
    ...
  ]
}
```

### 4.2 WebSocket 메시지 포맷

```json
// 진행상황 업데이트
{
  "event": "progress",
  "session_id": "sess_abc123",
  "total_symbols": 200,
  "completed_symbols": 75,
  "current_symbol": { "code": "003550", "name": "LG" },
  "elapsed_time_sec": 450,
  "eta_sec": 120
}

// 완료 통지
{
  "event": "completed",
  "session_id": "sess_abc123",
  "total_time_sec": 540,
  "total_profit": 450000,
  "profit_rate_pct": 4.5
}

// 오류 통지
{
  "event": "error",
  "session_id": "sess_abc123",
  "error_code": "DATA_FETCH_ERROR",
  "message": "Yahoo Finance 데이터 수집 실패"
}
```

---

## 5. 데이터 모델

### 5.1 데이터베이스 스킴 (SQLite)

```sql
-- 설정 정보
CREATE TABLE config (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  config_name TEXT NOT NULL,
  strategy_type TEXT NOT NULL, -- 'daily_trading' or 'trailing_stop'
  strategy_params TEXT NOT NULL, -- JSON 형식
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 백테스팅 세션
CREATE TABLE backtest_session (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  session_id TEXT UNIQUE NOT NULL,
  config_id INTEGER NOT NULL REFERENCES config(id),
  blacklist TEXT, -- JSON 배열
  whitelist TEXT, -- JSON 배열
  status TEXT DEFAULT 'running', -- 'running', 'completed', 'cancelled'
  total_symbols INTEGER DEFAULT 0,
  start_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  end_time TIMESTAMP,
  total_profit DECIMAL(15, 2),
  total_loss DECIMAL(15, 2),
  profit_rate DECIMAL(10, 4)
);

-- 종목별 결과
CREATE TABLE backtest_result (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  session_id TEXT NOT NULL REFERENCES backtest_session(session_id),
  symbol_code TEXT NOT NULL,
  symbol_name TEXT NOT NULL,
  trade_count INTEGER DEFAULT 0,
  win_count INTEGER DEFAULT 0,
  loss_count INTEGER DEFAULT 0,
  total_profit DECIMAL(15, 2) DEFAULT 0,
  total_loss DECIMAL(15, 2) DEFAULT 0,
  profit_rate DECIMAL(10, 4) DEFAULT 0,
  UNIQUE(session_id, symbol_code)
);

-- 거래 상세 내역
CREATE TABLE trade_detail (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  session_id TEXT NOT NULL,
  symbol_code TEXT NOT NULL,
  trade_sequence INTEGER NOT NULL, -- 1, 2, 3, ... (종목별 거래 순번)
  buy_time TIMESTAMP NOT NULL,
  buy_price DECIMAL(15, 2) NOT NULL,
  sell_time TIMESTAMP NOT NULL,
  sell_price DECIMAL(15, 2) NOT NULL,
  profit DECIMAL(15, 2), -- 양수면 수익, 음수면 손해
  cost_amount DECIMAL(15, 2), -- 비용액 (세금+수수료)
  net_profit DECIMAL(15, 2), -- 비용 차감 후 순 수익
  FOREIGN KEY (session_id) REFERENCES backtest_session(session_id),
  UNIQUE(session_id, symbol_code, trade_sequence)
);
```

### 5.2 캐시 데이터 구조 (메모리)

```
stockDataCache: {
  "005930": {
    "lastUpdated": "2026-02-08T12:00:00Z",
    "fetchDate": "2026-02-08",           // 수집 날짜 (일일 1회 판별 기준)
    "data": [
      { "timestamp": "2026-02-01 09:30", "open": 70000, "high": 71000, "low": 69500, "close": 70500, "volume": 1000000 },
      ...
    ]
  },
  ...
}

// 캐시 유효성 판별 로직:
// isCacheValid(cachedData) → cachedData.fetchDate === today() 이면 유효
// ※ SRS NFR-301: Yahoo Finance 데이터 일일 1회만 수집
```

---

## 6. 배포 아키텍처 및 DevOps

### 6.1 배포 구조

```
로컬 PC
├── frontend (port 3000)
│   ├── public/
│   │   ├── index.html
│   │   ├── css/
│   │   └── js/
│   └── package.json
├── backend (port 8000)
│   ├── server.js
│   ├── routes/
│   ├── services/
│   ├── data/
│   └── package.json
├── python-engine/ (백테스팅 엔진)
│   ├── backtest_engine.py
│   ├── strategy_executor.py
│   └── requirements.txt
└── database/
    └── backtest.db
```

### 6.2 배포 단계

1. **개발 환경 구성**:
   ```bash
   # 프론트엔드
   cd frontend
   npm install
   npm start  # localhost:3000

   # 백엔드
   cd ../backend
   npm install
   npm start  # localhost:8000

   # Python 엔진
   cd ../python-engine
   pip install -r requirements.txt
   ```

2. **Docker 배포** (선택 사항):
   ```bash
   docker-compose up
   ```

### 6.3 모니터링 및 로깅

- **로그 파일**: `logs/app.log`, `logs/backtest.log`
- **로그 레벨**: INFO, WARNING, ERROR
- **메트릭**:
  - 백테스팅 평균 처리 시간
  - API 응답 시간
  - 데이터 캐시 히트율

---

## 7. 보안 고려사항

- **로컬 배포**: localhost만 허용 (외부 접근 차단)
- **HTTPS**: 로컬이므로 필수 아님
- **입력 검증**: 모든 API 입력값 검증 및 샌드박싱
- **에러 로깅**: 민감한 정보(API 키 등) 로깅 제외

---

## 8. 성능 목표

| 지표 | 목표 |
|------|------|
| 백테스팅 처리 시간 (200개 종목) | 5분 이내 |
| API 응답 시간 | 500ms 이내 |
| 차트 렌더링 시간 | 1초 이내 |
| UI 반응성 | 100ms 이내 |

---

## 9. 확장성 고려사항

- **모듈화 설계**: 향후 모듈별 분리 용이
- **API 버전 관리**: /api/v1/, /api/v2/, ...
- **데이터베이스**: SQLite → PostgreSQL 마이그레이션 경로 확보
- **캐시**: 메모리 + 디스크(일일 캐시) → Redis 마이그레이션 경로 확보

---

## 10. 리뷰 및 승인

- **작성자**: HLD 아키텍처 담당자
- **리뷰어**: LLD 담당자, DevOps 담당자
- **최종 승인**: 프로젝트 매니저

